<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Bike — Live Tracker Dashboard</title>
  <meta name="description" content="Single-file Bike Live Tracker dashboard (embed, fallback, heatmap, playback, geofence, QR, PWA-ready)"/>
  <style>
    :root{--blue:#0b76ef;--muted:#666}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#f6f8fb}
    header{background:linear-gradient(90deg,var(--blue),#136df0);color:#fff;padding:12px 16px;font-weight:700}
    .wrap{max-width:1200px;margin:12px auto;padding:12px;display:flex;gap:12px;flex-wrap:wrap}
    .panel{background:#fff;border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(10,10,10,0.06);flex:1;min-width:320px}
    .left{flex:0 0 380px}
    .right{flex:1;min-width:340px}
    label{display:block;font-size:0.9rem;color:var(--muted);margin-top:8px}
    input[type=text],select,button{width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ee;font-size:14px}
    button{background:var(--blue);color:#fff;border:0;cursor:pointer}
    .row{display:flex;gap:8px;margin-top:8px}
    .row button{flex:1}
    #trackerFrame{width:100%;height:480px;border-radius:8px;border:1px solid #eee}
    #map{height:520px;border-radius:8px}
    .hint{color:var(--muted);font-size:0.9rem;margin-top:8px}
    .badge{display:inline-block;padding:6px 10px;border-radius:8px;background:#f2f7ff;color:var(--blue);font-weight:600}
    footer{padding:10px;text-align:center;color:#666;font-size:0.9rem;margin-top:12px}
    .small{font-size:0.9rem;color:#666}
    .inline-btn{display:inline-block;padding:6px 8px;border-radius:8px;background:#eef6ff;color:var(--blue);cursor:pointer;margin-right:6px}
    .fallback{padding:14px;text-align:center}
    pre.smallcode{background:#f7f9fc;padding:8px;border-radius:6px;overflow:auto}
  </style>
  <!-- Leaflet + heat plugin -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
</head>
<body>
  <header>My Bike — Live Tracker Dashboard</header>

  <div class="wrap">
    <div class="panel left">
      <label>Permanent sharing link (paste করো)</label>
      <input id="shareUrl" placeholder="http://.../sharing/xxxxxxxxxxxxxxxxxxxxxxxx" />
      <div class="row" style="margin-top:8px">
        <button id="loadBtn">Load / Embed</button>
        <button id="openBtn" style="background:#2dbe60">Open in new tab</button>
      </div>
      <div class="hint">Embed না হলে Open-in-new-tab বাটন কাজ করবে।</div>

      <label style="margin-top:12px">Status</label>
      <div class="row">
        <div class="badge" id="statusBadge">Not checked</div>
        <div style="flex:1"><small id="lastPing">—</small></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="pingBtn">Ping Link</button>
        <button id="genQR">Generate QR</button>
      </div>

      <label style="margin-top:12px">Quick SMS commands (copy)</label>
      <div class="hint small">Phone থেকে tracker SIM-এ পাঠাবে</div>
      <div class="row" style="margin-top:8px">
        <button data-cmd="URL#" class="cmd">Copy URL#</button>
        <button data-cmd="G#" class="cmd">Copy G#</button>
        <button data-cmd="check#" class="cmd">Copy check#</button>
      </div>

      <label style="margin-top:12px">Upload route CSV (lat,lng[,timestamp])</label>
      <input type="file" id="csvFile" accept=".csv,text/csv" />
      <div class="row" style="margin-top:8px">
        <button id="showHeat">Show Heatmap</button>
        <button id="playback">Playback</button>
        <button id="clearMap" style="background:#ff6b6b">Clear</button>
      </div>
      <div class="hint small">CSV example row: <code>23.796408,90.436123,2025-11-13T11:30:00Z</code></div>

      <label style="margin-top:12px">Geofence simulator</label>
      <div class="row">
        <input id="geoLat" placeholder="lat e.g. 23.7964" />
        <input id="geoLng" placeholder="lng e.g. 90.4361" />
      </div>
      <div class="row" style="margin-top:8px">
        <input id="geoRad" placeholder="radius (meters)" />
        <button id="setFence">Set Fence</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="testCoords">Test Coords</button>
        <button id="addHome" style="background:#444">How to add</button>
      </div>

      <label style="margin-top:12px">Tracker Info / Debug</label>
      <div id="infoBox" class="small">No device info yet. Paste link, click Ping.</div>
    </div>

    <div class="panel right">
      <div id="embedArea">
        <iframe id="trackerFrame" src="about:blank" title="Live tracker" sandbox></iframe>
      </div>
      <div id="map" style="margin-top:12px"></div>
    </div>
  </div>

  <footer>Made with ♥ — keep your sharing link private if you want privacy.</footer>

  <!-- libs -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <script>
  /*******************************
   * CONFIG - তুমি এখানে নিজের link বসাবে
   *******************************/
  // DEFAULT: তুমি চাইলে এখানে তোমার permanent sharing link বসিয়ে দিতে পারো
  const DEFAULT_SHARING = 'http://gps.francebangla.net/sharing/3cc72e30b02e2948c35e7c96ba602695';

  // Ping timeout (ms)
  const PING_TIMEOUT = 12000;

  /*******************************
   * App logic - কোন change করলে খারাপ হবে না
   *******************************/
  const $ = s => document.querySelector(s);
  const shareInput = $('#shareUrl');
  const frame = $('#trackerFrame');
  const statusBadge = $('#statusBadge');
  const lastPing = $('#lastPing');
  const infoBox = $('#infoBox');

  // set default
  shareInput.value = DEFAULT_SHARING;

  // Map init
  const map = L.map('map').setView([23.7964,90.4361], 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'© OpenStreetMap'}).addTo(map);
  let marker=null, heatLayer=null, playbackLayer=null, fence=null;

  function showMarker(lat,lng){
    const pos=[lat,lng];
    if(!marker) marker = L.marker(pos).addTo(map);
    else marker.setLatLng(pos);
    map.setView(pos,16);
  }

  // -- embed handling
  document.getElementById('loadBtn').addEventListener('click', ()=> loadEmbed(shareInput.value.trim()));
  document.getElementById('openBtn').addEventListener('click', ()=> {
    const u = shareInput.value.trim(); if(!u) return alert('Paste sharing link first'); window.open(u, '_blank');
  });

  // copy quick commands
  document.querySelectorAll('.cmd').forEach(b=>{
    b.addEventListener('click', e=>{
      const c = e.target.dataset.cmd;
      navigator.clipboard.writeText(c).then(()=> alert('Copied: '+c));
    });
  });

  // ping: try fetch() to read body (CORS may block)
  async function ping(url){
    if(!url) return setStatus('No URL','gray');
    setStatus('Checking...','orange');
    const t0 = Date.now();
    try{
      const controller = new AbortController();
      const id = setTimeout(()=>controller.abort(), PING_TIMEOUT);
      const resp = await fetch(url, {mode:'cors', signal: controller.signal});
      clearTimeout(id);
      const took = Date.now() - t0;
      if(resp.ok){
        setStatus('Online (CORS ok) - '+took+'ms','green');
        lastPing.textContent = new Date().toLocaleString();
        const txt = await resp.text();
        extractCoordsFromText(txt);
        infoBox.textContent = 'Server replied (CORS ok). Parsed coords if any.';
      } else {
        setStatus('HTTP '+resp.status,'red');
        infoBox.textContent = 'Server returned HTTP '+resp.status;
      }
    }catch(err){
      console.warn('Ping error', err);
      setStatus('Blocked / No CORS','red');
      lastPing.textContent = new Date().toLocaleString();
      // still attempt a non-CORS img hack to detect reachable (best-effort)
      probeURL(url).then(ok=>{
        if(ok){ setStatus('Online (no CORS)','green'); infoBox.textContent = 'Server reachable but blocked CORS; use Open-in-new-tab.'; }
        else infoBox.textContent = 'Server not reachable (might be down).';
      });
    }
  }

  document.getElementById('pingBtn').addEventListener('click', ()=> ping(shareInput.value.trim()));

  function setStatus(text, color){
    statusBadge.textContent = text;
    statusBadge.style.background = (color==='green')? '#e6fbf0' : (color==='red'? '#fff0f0' : (color==='orange'? '#fff7e6' : '#f2f7ff'));
    statusBadge.style.color = (color==='green')? '#108a4b' : (color==='red'? '#d23' : '#a36f00');
  }

  // try to fetch a URL by creating an Image element (bypasses CORS for simple reachability)
  function probeURL(url){
    return new Promise(resolve=>{
      try{
        const img = new Image();
        img.onload = ()=> resolve(true);
        img.onerror = ()=> resolve(false);
        // append timestamp to avoid cache
        img.src = url + (url.includes('?')? '&' : '?') + '_ping=' + Date.now();
        // fallback timeout
        setTimeout(()=> resolve(false), 5000);
      } catch(e){ resolve(false); }
    });
  }

  // attempt embed + fallback
  function loadEmbed(url){
    if(!url){ alert('Paste the sharing URL first'); return; }
    // reset embed area to iframe
    document.getElementById('embedArea').innerHTML =
      '<iframe id="trackerFrame" src="about:blank" title="Live tracker" sandbox></iframe>';
    const ifr = document.getElementById('trackerFrame');
    let loaded=false;
    ifr.addEventListener('load', ()=> { loaded=true; setStatus('Embedded (loaded)','green'); lastPing.textContent=new Date().toLocaleString(); });
    // set src (iframe)
    try{ ifr.src = url; } catch(e){ console.warn(e); }
    // fallback detection (mixed-content or X-Frame-Options)
    setTimeout(()=> {
      if(!loaded){
        document.getElementById('embedArea').innerHTML =
          '<div class="fallback"><p>Embedding blocked (mixed-content or framing). Open in new tab:</p>' +
          '<div style="margin-top:8px"><a href="'+escapeHtml(url)+'" target="_blank" style="display:inline-block;padding:10px 14px;background:#0b76ef;color:white;border-radius:8px;text-decoration:none">Open Live Tracker</a></div></div>';
        setStatus('Embed blocked (open in new tab)','red');
      }
    }, 1800);
  }

  function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // try to parse google maps q=lat,lng or direct decimal lat/lng from HTML
  function extractCoordsFromText(txt){
    const m = txt.match(/[?&]q=([N\d\.\-]+),([E\d\.\-]+)/i) || txt.match(/q=([\d\.\-]+),([\d\.\-]+)/i) || txt.match(/([0-9]{1,2}\.[0-9]+)[,\s]+([0-9]{1,3}\.[0-9]+)/);
    if(m){
      const lat = parseFloat(m[1].replace('N',''));
      const lng = parseFloat(m[2].replace('E',''));
      if(!isNaN(lat) && !isNaN(lng)){
        showMarker(lat,lng);
        infoBox.textContent = 'Last known: '+lat.toFixed(6)+', '+lng.toFixed(6);
      }
    } else {
      // no coords parsed
    }
  }

  // CSV heatmap & playback
  document.getElementById('showHeat').addEventListener('click', ()=>{
    const f = document.getElementById('csvFile').files[0]; if(!f) return alert('Upload a CSV file first');
    const reader = new FileReader();
    reader.onload = e=> {
      const rows = e.target.result.split(/\r?\n/).map(r=>r.trim()).filter(Boolean);
      const pts = rows.map(r=> {
        const c = r.split(/[;, \t]/).map(x=>x.trim()); return [parseFloat(c[0]), parseFloat(c[1])];
      }).filter(p=>p && !isNaN(p[0]));
      if(heatLayer) map.removeLayer(heatLayer);
      heatLayer = L.heatLayer(pts, {radius:25}).addTo(map);
      if(pts.length) map.fitBounds(L.latLngBounds(pts));
    };
    reader.readAsText(f);
  });

  document.getElementById('playback').addEventListener('click', ()=>{
    const f = document.getElementById('csvFile').files[0]; if(!f) return alert('Upload CSV first');
    const reader = new FileReader();
    reader.onload = e=>{
      const rows = e.target.result.split(/\r?\n/).map(r=>r.trim()).filter(Boolean);
      const pts = rows.map(r=>{ const c = r.split(/[;, \t]/).map(x=>x.trim()); return {lat:parseFloat(c[0]), lng:parseFloat(c[1]), t:c[2]||''}; })
                      .filter(p=>p && !isNaN(p.lat));
      if(playbackLayer) map.removeLayer(playbackLayer);
      if(marker) map.removeLayer(marker);
      playbackLayer = L.layerGroup().addTo(map);
      if(pts.length) map.fitBounds(L.latLngBounds(pts.map(p=>[p.lat,p.lng])));
      let i=0;
      const iv = setInterval(()=>{
        if(i>=pts.length){ clearInterval(iv); return; }
        const p = pts[i++];
        showMarker(p.lat,p.lng);
        L.circleMarker([p.lat,p.lng], {radius:5}).addTo(playbackLayer);
      }, 700);
    };
    reader.readAsText(f);
  });

  document.getElementById('clearMap').addEventListener('click', ()=> {
    if(heatLayer) map.removeLayer(heatLayer);
    if(playbackLayer) map.removeLayer(playbackLayer);
    if(marker) map.removeLayer(marker);
    heatLayer = playbackLayer = marker = null;
  });

  // geofence
  document.getElementById('setFence').addEventListener('click', ()=>{
    const lat = parseFloat($('#geoLat').value), lng = parseFloat($('#geoLng').value), r = parseFloat($('#geoRad').value);
    if(isNaN(lat)||isNaN(lng)||isNaN(r)) return alert('Provide valid numbers');
    if(fence) map.removeLayer(fence);
    fence = L.circle([lat,lng], {radius:r, color:'#ff6b6b', fillColor:'#ff6b6b', fillOpacity:0.12}).addTo(map);
    map.fitBounds(fence.getBounds());
  });

  document.getElementById('testCoords').addEventListener('click', ()=>{
    const lat = parseFloat($('#geoLat').value), lng = parseFloat($('#geoLng').value);
    if(isNaN(lat)||isNaN(lng)) return alert('Provide coords');
    const inside = fence && fence.getBounds().contains([lat,lng]);
    alert(inside? 'TEST: Coordinates are INSIDE the fence' : 'TEST: Coordinates are OUTSIDE the fence');
  });

  // QR
  document.getElementById('genQR').addEventListener('click', ()=>{
    const u = shareInput.value.trim(); if(!u) return alert('Paste the sharing URL first');
    const qr = 'https://chart.googleapis.com/chart?cht=qr&chs=300x300&chl='+encodeURIComponent(u);
    const w = window.open('', '_blank'); w.document.write('<img src="'+qr+'" />');
  });

  // addHome tip
  document.getElementById('addHome').addEventListener('click', ()=> {
    alert('Android (Chrome): 3-dots → Add to Home screen.\niPhone (Safari): Share → Add to Home Screen.');
  });

  // probe on load
  setTimeout(()=> { loadEmbed(DEFAULT_SHARING); ping(DEFAULT_SHARING); }, 600);

  /*******************************
   * Single-file PWA: create manifest + service worker via Blob
   * (so we don't need extra files). This is best-effort and minimal.
   *******************************/
  (function registerPWA(){
    // create manifest blob
    try{
      const manifest = {
        name: "My Bike Tracker",
        short_name: "BikeTrack",
        start_url: "/",
        display: "standalone",
        background_color: "#ffffff",
        theme_color: "#0b76ef",
        icons: []
      };
      const mm = new Blob([JSON.stringify(manifest)], {type:'application/json'});
      const mmUrl = URL.createObjectURL(mm);
      const link = document.createElement('link'); link.rel='manifest'; link.href = mmUrl;
      document.head.appendChild(link);

      // service worker code as string
      const swCode = `
        const CACHE = 'bike-track-v1';
        const FILES = ['/', '/index.html'];
        self.addEventListener('install', e => { e.waitUntil(caches.open(CACHE).then(c=>c.addAll(FILES)).catch(()=>{})); self.skipWaiting(); });
        self.addEventListener('activate', e => { e.waitUntil(self.clients.claim()); });
        self.addEventListener('fetch', e => { e.respondWith(caches.match(e.request).then(r=> r || fetch(e.request))); });
      `;
      const swBlob = new Blob([swCode], {type:'text/javascript'});
      const swUrl = URL.createObjectURL(swBlob);
      if('serviceWorker' in navigator){
        navigator.serviceWorker.register(swUrl).catch(err=> console.warn('SW register failed', err));
      }
    }catch(e){ console.warn('PWA setup failed', e); }
  })();

  /*******************************
   * small helpers
   *******************************/
  function $(s){ return document.querySelector(s); }

  // initial embed function exposed
  window.loadEmbed = loadEmbed;
  window.ping = ping;

  </script>

</body>
</html>
